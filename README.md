ğŸ”¥ä»é›¶æ‰‹å†™vue2 - templateæ¨¡ç‰ˆè§£æ

æœ¬ä¸“æ æ˜¯æ‰“ç®—ä»é›¶æ‰‹å†™ä¸€ä¸ª vue2ï¼Œå¹¶å­¦ä¹  vue2 ä¸­çš„ä¸€äº›æ ¸å¿ƒç†å¿µã€‚

[ä¸“æ æ–‡ç« ä¸€ - ğŸ”¥ä»é›¶æ‰‹å†™vue2 - è™šæ‹ŸèŠ‚ç‚¹ä»¥åŠcreateElementå‡½æ•°](https://juejin.cn/post/7421103437607370806)

# ä¸€ã€templateé€‰é¡¹

åœ¨è™šæ‹ŸèŠ‚ç‚¹é‚£èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° vueæ¡†æ¶ æ˜¯åŸºäº vnode æ¥æ¸²æŸ“é¡µé¢çš„ã€‚

åœ¨ vue ä¸­ï¼Œå¯ä»¥å°† template ä½œä¸ºé€‰é¡¹ä¼ å…¥ vue æ„é€ å‡½æ•°ã€‚

```js
new Vue({
  template:`æˆ‘æ˜¯ template å†…å®¹ï¼Œæ˜¯ä¸€ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²`
})
```
templateå†…å®¹å¦‚ä¸‹ã€‚
```js
"<div>
  <span>æˆ‘æ˜¯çˆ±åƒæ°´æœçš„äºº</span>
  æˆ‘åƒå„ç§å„æ ·çš„æ°´æœ
  <ul>
    <li>ç«é¾™æœ</li>
    <li>è‘¡è„</li>
    <li>ç•ªèŒ„</li>
  </ul>
</div>"
```
vue å°±æ˜¯å°†è¿™æ ·ä¸€ä¸ªæ¨¡æ¿å­—ç¬¦ä¸²å˜æˆ vnode çš„ã€‚

æ‹¿åˆ° vnodeä»¥åï¼Œå°±å¯ä»¥å°† vnodeè½¬åŒ–æˆçœŸå® DOM å…ƒç´ ç„¶åæ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚

æ¸²æŸ“åŠŸèƒ½æˆ‘ä»¬åé¢çš„ç« èŠ‚ä¼šå¸¦ç€å¤§å®¶ä¸€æ­¥ä¸€æ­¥å»å®ç°ã€‚

æˆ‘ä»¬åœ¨æœ¬ç« ä¸­ä¼šä¸€æ­¥ä¸€æ­¥å¸¦å¤§å®¶å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡æ¿è§£æå™¨ã€‚

# äºŒã€æ¨¡æ¿ç¼–è¯‘è½¬åŒ–æ­¥éª¤

åœ¨ vue-template-compiler ä¸­ï¼Œæ¨¡æ¿è§£æå¤§è‡´åˆ†ä¸º 2 æ­¥ï¼š

1. å°†æ¨¡æ¿è½¬åŒ–æˆ AST
2. å°† ASTè½¬åŒ–æˆ render å‡½æ•° 

æ‰€ä»¥ä¸Šé¢çš„æ¨¡æ¿æœ€ç»ˆä¼šå˜æˆä¸‹é¢çš„renderå‡½æ•°ï¼š

```js
render:new Function(`with(this){return _c('div',[
  _c('span',[
    _v("æˆ‘æ˜¯çˆ±åƒæ°´æœçš„äºº")
  ]),
  _v("            æˆ‘åƒå„ç§å„æ ·çš„æ°´æœ            "),
  _c('ul',[
    _c('li',[_v("ç«é¾™æœ")]),
    _v(" "),
    _c('li',[_v("è‘¡è„")]),
    _v(" "),
    _c('li',[_v("ç•ªèŒ„")])
  ])
])}`)
``` 

> _cå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„ createElement ã€‚
>
> createElementæ˜¯æ–¹ä¾¿æˆ‘ä»¬ç”Ÿæˆ vnodeçš„ã€‚
>
> _vå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„åˆ›å»ºæ–‡æœ¬çš„å‡½æ•°ï¼š```createTextVNode```ã€‚

```new Function()``` å¯ä»¥æ ¹æ®å‚æ•°å†…å®¹ç”Ÿæˆä¸€ä¸ªå‡½æ•°ã€‚

è€Œ```with(this)```è¯­å¥æ„å‘³ç€å‡½æ•°ä½“å†…çš„æ‰€æœ‰å˜é‡éƒ½å°†ä» thiså¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œæ¯”å¦‚ä¸Šé¢çš„```_vã€_c```ã€‚

æ‰€ä»¥æ‰§è¡Œç”Ÿæˆçš„ render å‡½æ•°å°±å¯ä»¥è·å–æ¨¡æ¿å¯¹åº”çš„ vnodeã€‚

## 2.1 ç¬¬ä¸€æ­¥ï¼šå°† templateæ¨¡æ¿ è½¬åŒ–æˆ AST

å› ä¸ºæ¨¡æ¿å°±æ˜¯ä¸€æ®µå­—ç¬¦ä¸²ï¼Œæ˜¯éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¸åˆ©äºè¿›è¡Œåˆ†æã€‚

æ‰€ä»¥ç¬¬ä¸€æ­¥æ˜¯å°†éç»“æ„åŒ–çš„æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ¢å˜æˆç»“æ„åŒ–çš„ JSå¯¹è±¡ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼Œå³ ASTã€‚

è¿™ä¸ªç½‘ç«™[ast](https://astexplorer.net/)å¯ä»¥å°†æ¨¡æ¿è½¬æˆæˆå¯¹åº”çš„ ASTã€‚

> æ³¨æ„è§£æå†…å®¹é€‰æ‹© ```Vue```ï¼Œè§£æå™¨é€‰æ‹© ```vue-template-compiler```ã€‚

![alt text](image.png)


## 2.2 ç¬¬äºŒæ­¥ï¼šå°† AST è½¬åŒ–ä¸º render å‡½æ•°

åœ¨å¾—åˆ° æ¨¡æ¿ å¯¹åº”çš„ AST å¯¹è±¡ä»¥åã€‚
 
å…ˆè½¬æ¢ä¸ºä¸€æ®µå‡½æ•°ä½“çš„å­—ç¬¦ä¸²ï¼Œç„¶åå†ç”¨ ```new Function(`with(this){return å‡½æ•°é¢˜å­—ç¬¦ä¸²}`)```ç”Ÿæˆå¯¹åº”çš„ renderå‡½æ•°ã€‚

# ä¸‰ã€ç¼–è¯‘å™¨æ¨¡æ¿æºç ç›®å½•çš„å¤æ‚æ€§

ä¸ºäº†æ–¹ä¾¿ç¼–è¯‘å™¨åç»­è¿›è¡Œæ‹†åˆ†å’Œæ‰©å±•ï¼Œç¼–å†™äº†çš„å¾ˆå¤æ‚ï¼Œæºç å‡½æ•°äº’ç›¸è°ƒç”¨ï¼Œè®©äººéš¾ä»¥ç†è§£ã€‚

## 3.1 compileToFunctions

ä»åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯â€œç¼–è¯‘æˆå‡½æ•°â€œã€‚

åœ¨ vue æºç ä¸­æˆ‘ä»¬åˆ©ç”¨ compileToFunctions æ–¹æ³• ç”Ÿæˆrenderå‡½æ•°ã€‚

```js
// ç”Ÿæˆrenderå‡½æ•°
const { render } = compileToFunctions(template, this);
```
compileToFunctionså‡½æ•°åœ¨ platforms/web/compiler ä¸­å®šä¹‰ã€‚ 
```js
// è°ƒç”¨createCompilerç”ŸæˆcompileToFunctionså‡½æ•°
// baseOptionsåŒ…å«äº†ç¼–è¯‘æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ç±»å’Œé€‰é¡¹ç­‰
const { compileToFunctions } = createCompiler(baseOptions)
```
> baseOptionsåŒ…å«äº†ç¼–è¯‘æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ç±»å’Œé€‰é¡¹ç­‰ã€‚

## 3.2 createCompiler

ä»åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯â€œåˆ›å»ºç¼–è¯‘å‡½æ•°â€œã€‚

å¯¹åº”çš„ä»£ç åœ¨ compiler/index.js æ–‡ä»¶ä¸­ã€‚

æ‰€ä»¥ createCompiler å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸Šæœ‰ä¸€ä¸ªrenderå±æ€§ï¼Œå€¼æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

è€Œ createCompiler å‡½æ•°æ˜¯ç”± createCompilerCreator å‡½æ•°ç”Ÿæˆçš„ã€‚

```js
export const createCompiler = createCompilerCreator(function baseCompile(
    template,
    options
) {
    //xxx
})
```

## 3.3 createCompilerCreator

ä»åå­—æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯â€œåˆ›å»ºç¼–è¯‘å‡½æ•°çš„æ„é€ å‡½æ•°â€œã€‚

å¯ä»¥å¾—å‡ºcreateCompilerCreatorçš„è¿”å›å€¼å³ä¸º createCompilerå‡½æ•°ã€‚ 

```js
export function createCompilerCreator(baseCompile){
    return function createCompiler(baseOptions){
      return {
        compileToFunctions: createCompileToFunctionFn(compile)
      }
    }
}
```

## 3.4 compileå‡½æ•°

æœ€åï¼Œæˆ‘ä»¬å°†ç›®å…‰è½åˆ°äº†```createCompileToFunctionFn(compile)```ä¸­ã€‚

åœ¨è¿™ä¸ª compiledå‡½æ•°ä¸­å®é™…ä¸Šè°ƒç”¨äº†æ¨¡æ¿ç¼–è¯‘çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”Ÿæˆäº†


